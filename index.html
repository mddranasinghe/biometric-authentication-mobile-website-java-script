<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAuthn Demo</title>
</head>
<body>
    <h1>WebAuthn Demo</h1>

    <!-- Registration Button -->
    <h2>Registration</h2>
    <button id="registerButton">Register Credentials</button>

    <!-- Authentication Button -->
    <h2>Authentication</h2>
    <button id="authenticateButton">Authenticate</button>

    <!-- Error message display area -->
    <div id="errorMessage" style="color: red;"></div>

    <script>
        // Function to display error message on the web page
        function displayError(message) {
            document.getElementById('errorMessage').innerText = message;
        }

        // Function to handle registration of WebAuthn credentials
        async function registerCredentials() {
            try {
                // Check if the browser supports PublicKeyCredential API
                if (!window.PublicKeyCredential) { 
                    throw new Error('Client not capable of the API.');
                }

                // Define public key options for registration
                const publicKeyOptions = {
                    challenge: new Uint8Array([21, 31, 105 /* Add more random bytes generated by the server */]),
                    rp: {
                        name: "ACME Corporation"
                    },
                    user: {
                        id: new Uint8Array([21, 31, 105]),
                        name: "alex.mueller@example.com",
                        displayName: "Alex MÃ¼ller",
                    },
                    pubKeyCredParams: [
                        { type: "public-key", alg: -7 }, // "ES256" as registered in the IANA COSE Algorithms registry
                        { type: "public-key", alg: -257 } // Value registered by this specification for "RS256"
                    ],
                    authenticatorSelection: {
                        userVerification: "preferred"
                    },
                    timeout: 360000,  // 6 minutes
                    excludeCredentials: [ /* Add credentials to exclude if any */ ],
                    extensions: { "appidExclude": "https://acme.example.com" }
                };

                // Create new credential
                const newCredentialInfo = await navigator.credentials.create({ publicKey: publicKeyOptions });

                // Send new credential info to server for verification and registration.
                console.log('New credential created:', newCredentialInfo);
                displayError('New credential created');
            } catch (err) {
                // Handle errors
                console.error('Error creating new credential:', err);
                displayError('Error creating new credential: ' + err.message);
            }
        }

        // Function to handle authentication using WebAuthn credentials
        async function authenticate() {
            try {
                // Check if the browser supports PublicKeyCredential API
                if (!window.PublicKeyCredential) { 
                    throw new Error('Client not capable of the API.');
                }

                // Define options for authentication
                const options = {
                    challenge: new Uint8Array([4, 101, 15 /* Add more random bytes generated by the server */]),
                    timeout: 120000,  // 2 minutes
                    allowCredentials: [ /* Add acceptable credentials here */ ]
                };

                // Perform authentication
                const assertion = await navigator.credentials.get({ publicKey: options });

                // Send assertion to server for verification
                console.log('Assertion obtained:', assertion);
                displayError('Assertion obtained');
            } catch (err) {
                // Handle errors
                console.error('Error obtaining assertion:', err);
                displayError('Error obtaining assertion: ' + err.message);
            }
        }

        // Add event listeners to buttons
        document.getElementById('registerButton').addEventListener('click', registerCredentials);
        document.getElementById('authenticateButton').addEventListener('click', authenticate);
    </script>
</body>
</html>
