<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAuthn Demo</title>
</head>
<body>
    <h1>WebAuthn Demo</h1>

    <h2>Registration</h2>
    <button id="registerButton">Register Credentials</button>

    <h2>Authentication</h2>
    <button id="authenticateButton">Authenticate</button>

    <div id="errorMessage" style="color: red;"></div>

    <script>
        // Initialize IndexedDB
        let db;

        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = window.indexedDB.open('WebAuthnDB', 1);

                request.onerror = () => {
                    reject('Error opening IndexedDB');
                };

                request.onsuccess = () => {
                    db = request.result;
                    resolve();
                };

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    const store = db.createObjectStore('credentials', { keyPath: 'id' });
                    store.createIndex('credentialIndex', 'id', { unique: true });
                };
            });
        }

        // Function to store credentials in IndexedDB
        async function storeCredentials(credential) {
            const transaction = db.transaction(['credentials'], 'readwrite');
            const store = transaction.objectStore('credentials');
            store.add(credential);
        }

        // Function to retrieve credentials from IndexedDB
        async function getStoredCredential() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['credentials'], 'readonly');
                const store = transaction.objectStore('credentials');
                const request = store.getAll();

                request.onerror = () => {
                    reject('Error retrieving stored credential');
                };

                request.onsuccess = () => {
                    resolve(request.result[0]); // Assuming only one credential stored
                };
            });
        }

        // Function to handle authentication using WebAuthn credentials
        async function authenticate() {
            try {
                // Retrieve the stored credential from IndexedDB
                const storedCredential = await getStoredCredential();

                if (!storedCredential) {
                    console.error('No stored credential found.');
                    displayError('No stored credential found.');
                    return;
                } else {
                    console.log('Stored Credential:', storedCredential);
                    displayError('Stored Credential: ' + JSON.stringify(storedCredential));
                }

                // Generate a random challenge
                const challenge = new Uint8Array(32);

                // Create PublicKeyCredentialRequestOptions
                const publicKeyCredentialRequestOptions = {
                    challenge: challenge,
                    userVerification: 'required'
                };

                // Get credentials for authentication
                const credential = await navigator.credentials.get({
                    publicKey: publicKeyCredentialRequestOptions
                });

                // Calculate signed data
                const signedData = new Uint8Array([...credential.response.authenticatorData, ...credential.response.clientDataJSON]);

                // Verify the signature
                // Replace the following line with the appropriate signature verification method
                const signatureIsValid = await verifySignature(storedCredential.publicKey, credential.response.signature, signedData);

                if (signatureIsValid) {
                    console.log('Credential authenticated:', credential);
                    displayError('Credential authenticated', credential);
                } else {
                    console.error('Signature verification failed.');
                    displayError('Signature verification failed.');
                }
            } catch (error) {
                console.error('Error during WebAuthn authentication:', error);
                displayError('Error during WebAuthn authentication: ' + error.message);
            }
        }

        // Add event listeners to buttons
        document.getElementById('registerButton').addEventListener('click', async () => {
            await registerAndStoreCredentials();
            await storeCredentials(JSON.parse(localStorage.getItem('webauthnCredential')));
        });

        document.getElementById('authenticateButton').addEventListener('click', authenticate);

        // Initialize IndexedDB when the document is ready
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await initDB();
            } catch (error) {
                console.error('Error initializing IndexedDB:', error);
            }
        });
    </script>
</body>
</html>
